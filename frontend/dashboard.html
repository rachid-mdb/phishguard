<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PhishGuard – Dashboard</title>

  <!-- Bootstrap -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >

  <!-- Font Awesome (icônes) -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />

  <!-- Chart.js pour les graphiques -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body class="bg-light">

<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">
      <i class="fa-solid fa-chart-line text-primary me-2"></i>
      PhishGuard – Dashboard
    </h1>
    <a href="index.html" class="btn btn-outline-secondary">
      <i class="fa-solid fa-arrow-left me-1"></i>
      Retour à l'analyse
    </a>
  </div>

  <!-- Filtres -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title mb-3">Filtres</h5>
      <form id="filtersForm" class="row g-3">
        <div class="col-md-2">
          <label class="form-label">Verdict</label>
          <select id="filterVerdict" class="form-select">
            <option value="">Tous</option>
            <option value="phishing">Phishing</option>
            <option value="legit">Legit</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Label</label>
          <select id="filterLabel" class="form-select">
            <option value="">Tous</option>
            <option value="tp">TP (vrai positif)</option>
            <option value="tn">TN (vrai négatif)</option>
            <option value="fp">FP (faux positif)</option>
            <option value="fn">FN (faux négatif)</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Probabilité min.</label>
          <input
            type="number"
            step="0.01"
            min="0"
            max="1"
            id="filterMinProb"
            class="form-control"
            placeholder="0.8"
          >
        </div>
        <div class="col-md-2">
          <label class="form-label">Limit</label>
          <input
            type="number"
            id="filterLimit"
            class="form-control"
            value="50"
          >
        </div>
        <div class="col-md-4 d-flex align-items-end justify-content-end">
          <button type="button" class="btn btn-primary me-2" id="btnApplyFilters">
            Appliquer les filtres
          </button>
          <button type="button" class="btn btn-outline-secondary" id="btnResetFilters">
            Réinitialiser
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Graphique simple phishing vs legit -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-body">
          <h5 class="card-title mb-3">
            Répartition Phishing / Legit (sur les logs chargés)
          </h5>
          <canvas id="chartVerdict"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Tableau des logs -->
  <div class="card">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="card-title mb-0">Logs d'analyse</h5>
        <small id="logsCount" class="text-muted"></small>
      </div>
      <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
        <table class="table table-sm table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Date</th>
              <th>Subject</th>
              <th>URL</th>
              <th>Prob.</th>
              <th>Verdict</th>
              <th>Label</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="logsTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // ⚠️ même API Render que sur index.html
  const API_BASE = "https://phishguard-54zp.onrender.com";

  const logsTableBody = document.getElementById("logsTableBody");
  const logsCount = document.getElementById("logsCount");

  const filterVerdict = document.getElementById("filterVerdict");
  const filterLabel = document.getElementById("filterLabel");
  const filterMinProb = document.getElementById("filterMinProb");
  const filterLimit = document.getElementById("filterLimit");

  const btnApplyFilters = document.getElementById("btnApplyFilters");
  const btnResetFilters = document.getElementById("btnResetFilters");

  let chartVerdict = null;

  // Charge les logs depuis l'API avec les filtres actuels
  async function loadLogs() {
    const params = new URLSearchParams();
    const limitVal = filterLimit.value || "50";
    params.append("limit", limitVal);

    if (filterVerdict.value) params.append("verdict", filterVerdict.value);
    if (filterLabel.value) params.append("label", filterLabel.value);
    if (filterMinProb.value) {
      const val = parseFloat(filterMinProb.value);
      if (!isNaN(val)) params.append("min_prob", val.toString());
    }

    const url = `${API_BASE}/api/logs?` + params.toString();

    try {
      const response = await fetch(url);
      if (!response.ok) {
        alert("Erreur lors du chargement des logs : " + response.status);
        return;
      }

      const logs = await response.json();
      renderLogsTable(logs);
      updateVerdictChart(logs);
    } catch (err) {
      console.error(err);
      alert("Erreur réseau lors du chargement des logs.");
    }
  }

  // Affiche les logs dans le tableau
  function renderLogsTable(logs) {
    logsTableBody.innerHTML = "";
    logsCount.textContent = logs.length + " log(s) affiché(s)";

    logs.forEach(log => {
      const tr = document.createElement("tr");

      const tdDate = document.createElement("td");
      tdDate.textContent = log.timestamp.replace("T", " ").slice(0, 19);

      const tdSubj = document.createElement("td");
      tdSubj.textContent = log.subject || "(sans sujet)";

      const tdUrl = document.createElement("td");
      tdUrl.textContent = log.url || "";
      tdUrl.classList.add("text-truncate");
      tdUrl.style.maxWidth = "250px";

      const tdProb = document.createElement("td");
      tdProb.textContent = (log.probability * 100).toFixed(1) + " %";

      const tdVerdict = document.createElement("td");
      if (log.verdict === "phishing") {
        tdVerdict.innerHTML =
          '<i class="fa-solid fa-triangle-exclamation me-1"></i>PHISHING';
        tdVerdict.classList.add("text-danger", "fw-bold");
      } else {
        tdVerdict.innerHTML =
          '<i class="fa-solid fa-circle-check me-1"></i>LEGIT';
        tdVerdict.classList.add("text-success", "fw-bold");
      }

      const tdLabel = document.createElement("td");
      tdLabel.textContent = log.label ? log.label.toUpperCase() : "-";

      const tdActions = document.createElement("td");

      // Boutons label
      ["tp", "tn", "fp", "fn"].forEach(lbl => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className =
          "btn btn-sm me-1 " +
          (lbl === "fp" || lbl === "fn"
            ? "btn-outline-danger"
            : "btn-outline-success");
        btn.textContent = lbl.toUpperCase();
        btn.title = "Marquer comme " + lbl.toUpperCase();
        btn.addEventListener("click", () => markLabel(log.id, lbl));
        tdActions.appendChild(btn);
      });

      // Bouton delete
      const btnDelete = document.createElement("button");
      btnDelete.type = "button";
      btnDelete.className = "btn btn-sm btn-outline-secondary";
      btnDelete.textContent = "Suppr.";
      btnDelete.title = "Supprimer ce log";
      btnDelete.addEventListener("click", () => deleteLog(log.id));
      tdActions.appendChild(btnDelete);

      tr.appendChild(tdDate);
      tr.appendChild(tdSubj);
      tr.appendChild(tdUrl);
      tr.appendChild(tdProb);
      tr.appendChild(tdVerdict);
      tr.appendChild(tdLabel);
      tr.appendChild(tdActions);

      logsTableBody.appendChild(tr);
    });
  }

  // Marquer un log avec un label (fp / fn / tp / tn)
  async function markLabel(logId, label) {
    if (!confirm(`Confirmer le marquage du log ${logId} en ${label.toUpperCase()} ?`)) {
      return;
    }
    try {
      const response = await fetch(`${API_BASE}/api/report`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ log_id: logId, label })
      });
      if (!response.ok) {
        alert("Erreur lors de la mise à jour du label : " + response.status);
        return;
      }
      await loadLogs(); // recharger la liste
    } catch (err) {
      console.error(err);
      alert("Erreur réseau lors de la mise à jour du label.");
    }
  }

  // Supprimer un log
  async function deleteLog(logId) {
    if (!confirm(`Supprimer définitivement le log ${logId} ?`)) {
      return;
    }
    try {
      const response = await fetch(`${API_BASE}/api/logs/${logId}`, {
        method: "DELETE"
      });
      if (!response.ok) {
        alert("Erreur lors de la suppression : " + response.status);
        return;
      }
      await loadLogs();
    } catch (err) {
      console.error(err);
      alert("Erreur réseau lors de la suppression.");
    }
  }

  // Met à jour le graphique phishing vs legit
  function updateVerdictChart(logs) {
    let phishingCount = 0;
    let legitCount = 0;

    logs.forEach(log => {
      if (log.verdict === "phishing") phishingCount++;
      if (log.verdict === "legit") legitCount++;
    });

    const ctx = document.getElementById("chartVerdict");
    const data = {
      labels: ["Phishing", "Legit"],
      datasets: [{
        label: "Nombre de mails",
        data: [phishingCount, legitCount],
      }]
    };

    if (chartVerdict) {
      chartVerdict.data = data;
      chartVerdict.update();
    } else {
      chartVerdict = new Chart(ctx, {
        type: "bar",
        data: data,
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true } }
        }
      });
    }
  }

  // Gestion des boutons filtres
  btnApplyFilters.addEventListener("click", () => {
    loadLogs();
  });

  btnResetFilters.addEventListener("click", () => {
    filterVerdict.value = "";
    filterLabel.value = "";
    filterMinProb.value = "";
    filterLimit.value = "50";
    loadLogs();
  });

  // Chargement initial
  loadLogs();
</script>

</body>
</html>
